stages:
  - sonar

# Global CI variables
variables:
  # Ensure full history for proper blame & MR analysis in Sonar
  GIT_DEPTH: "0"
  # Extra Maven flags (batch mode, fail fast if tests fail)
  MAVEN_CLI_OPTS: "-B -Dmaven.test.failure.ignore=false"

sonar_maven:
  stage: sonar
  tags:
    - shell          # <-- this makes the job run on your shell runner
  cache:
    key: "${CI_PROJECT_NAME}-m2"
    paths:
      - .m2/repository
  before_script:
    - echo "Running on shell runner"
    - mvn -v
  script:
    # Use a local .m2 repo in the project workspace (good for caching)
    - mkdir -p .m2
    - mvn $MAVEN_CLI_OPTS \
        -Dmaven.repo.local="${CI_PROJECT_DIR}/.m2/repository" \
        clean verify \
        org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
        -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
        -Dsonar.projectName="$SONAR_PROJECT_NAME" \
        -Dsonar.host.url="$SONAR_HOST_URL" \
        -Dsonar.token="$SONAR_TOKEN" \
        -Dsonar.qualitygate.wait=true
  rules:
    # Run on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
    # And on merge request pipelines (for MR decoration)
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
